import hydra
import pytest

from tests.helpers.helpers import count_trainable_params
from tests.helpers.run_if import RunIf

test_cases = [("seg_pointnet++.yaml", 2, 6, 963682), ("seg_pointnet++.yaml", 4, 8, 964260)]


@RunIf(openpoints=True)
@pytest.mark.parametrize(
    "cfg_model, num_classes, num_feats, num_params", test_cases, indirect=["cfg_model"]
)
def test_seg_pointnetpp(cfg_model, num_classes, num_feats, num_params):
    model = hydra.utils.instantiate(cfg_model.model, num_classes=num_classes, num_feats=num_feats)

    assert count_trainable_params(model) == num_params
    assert model.net.encoder.channel_list[0] == num_feats
    assert model.net.head.head[2][0].out_channels == num_classes
